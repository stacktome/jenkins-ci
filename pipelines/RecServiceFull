podTemplate(label: 'mypod', containers: [
    containerTemplate(name: 'jnlp', image: 'gcr.io/fuzzylabs-1314/jnlp-slave-rec-service'),
    containerTemplate(name: 'sbt', image: 'hseeberger/scala-sbt', ttyEnabled: true, command: 'cat'),
    containerTemplate(name: 'cloud-sdk', image: 'google/cloud-sdk', ttyEnabled: true, command: 'cat'),
    containerTemplate(name: 'kubectl', image: 'lachlanevenson/k8s-kubectl', ttyEnabled: true, command: 'cat')
  ], volumes: [
    emptyDirVolume(mountPath: '/tmp/shared', memory: false),
    hostPathVolume(mountPath: '/usr/bin/docker', hostPath: '/usr/bin/docker'),
    hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')
  ]
) {
    slackSend color: 'good', message: "Build scheduled: ${env.BUILD_URL} (branch=$BRANCH)"

    node ('mypod') {
        
        try {
        
        stage 'Get code'
        git 'git@github.com:fuzzylabs/recommendation-service.git'
        sh 'git checkout $BRANCH'
        sh "git show -s --format=%H > /tmp/shared/commit-digest"
        container('sbt') {
            stage 'Run unit tests'
            sh 'sbt -no-colors test'
            
            stage 'Build docker image'
            sh 'sbt -no-colors docker:publishLocal'
            
            sh "sbt -no-colors version | tail -n 1 | awk '{print \$2}' > /tmp/shared/project-version"
        }
        container('cloud-sdk') {
            stage 'Push docker image to registry'
            sh "gcloud docker -- tag eu.gcr.io/fuzzylabs-1314/rec-service-image:v`cat /tmp/shared/project-version` eu.gcr.io/fuzzylabs-1314/rec-service-image:`cat /tmp/shared/commit-digest`"
            sh "gcloud docker -- tag eu.gcr.io/fuzzylabs-1314/rec-service-image:v`cat /tmp/shared/project-version` eu.gcr.io/fuzzylabs-1314/rec-service-image:latest"
            sh 'gcloud docker -- push eu.gcr.io/fuzzylabs-1314/rec-service-image:v`cat /tmp/shared/project-version`'
            sh 'gcloud docker -- push eu.gcr.io/fuzzylabs-1314/rec-service-image:`cat /tmp/shared/commit-digest`'
            sh 'gcloud docker -- push eu.gcr.io/fuzzylabs-1314/rec-service-image:latest'
            sh 'gcloud config set compute/zone europe-west1-d'
            sh 'gcloud container clusters get-credentials rec-service-cluster'
        }
        container('kubectl') {
            stage "Deploy to production"
            sh 'sed -i "s/latest/`cat /tmp/shared/commit-digest`/g" kubectl-deployment.yaml'
            sh 'kubectl replace -f kubectl-deployment.yaml --force --cascade --record'
        }
        
        } catch(exc) {
            slackSend color: 'danger', message: "Build failed: ${env.BUILD_URL}"
            throw exc
        }
        
        slackSend color: 'good', message: "Build completed: ${env.BUILD_URL}"
    }
}